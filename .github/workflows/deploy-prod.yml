on:
  release:
    types: [created]
  push:
    tags:
      - 'v*'

env:
  DOCKER_TLS_VERIFY: "1"
  DOCKER_HOST: "tcp://128.199.242.117:2376"
  DOCKER_CERT_PATH: "certs"

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Install Docker certs
        env:
          CA: ${{ secrets.CA }}
          CLIENT_CERT: ${{ secrets.CLIENT_CERT }}
          CLIENT_KEY: ${{ secrets.CLIENT_KEY }}
        run: |
          mkdir $DOCKER_CERT_PATH
          echo "$CA" > $DOCKER_CERT_PATH/ca.pem
          echo "$CLIENT_CERT" > $DOCKER_CERT_PATH/cert.pem
          echo "$CLIENT_KEY" > $DOCKER_CERT_PATH/key.pem
          docker-compose build
          docker-compose down
          docker-compose up -d --force-recreate
          rm -rf $DOCKER_CERT_PATH
